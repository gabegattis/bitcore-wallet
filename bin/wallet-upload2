#!/usr/bin/env node
'use strict';

var async = require('async');
var request = require('request');

var walletId = process.argv[2];
var filePath = process.argv[3];
var walletJSON = require(filePath);

var DEFAULT_URL = 'http://127.0.0.1:3001';
var ADDRESS_LIMIT = 2000;

var walletId = walletJSON.walletId;
var keys = walletJSON.keys;

var count = 0;

// async.whilst(moreKeysLeft, uploadChunk, function(err) {
//   if (err) {
//     console.log(err);
//   }
// });
//
//
// function moreKeysLeft() {
//   console.log(count,'/',keys.length);
//   return count < keys.length;
// }

function uploadChunk(callback) {
  var chunk = keys.slice(count, count + ADDRESS_LIMIT).map(function(key) {
    return key.address;
  });
  count += ADDRESS_LIMIT;
  uploadAddresses(chunk, callback);
}

function uploadAddresses(addresses, callback) {
  var options = {
    url: DEFAULT_URL + '/wallet-api/wallets/' + walletId + '/addresses',
    json: {
      addresses: addresses
    }
  };

  request.post(options, function(err, res, body) {
    if (err) {
      return callback(err);
    }
    console.log(res.statusCode);
    console.log(body);
    callback();
  });
}

var times = keys.length / ADDRESS_LIMIT;
var remainder = keys.length % ADDRESS_LIMIT;
if (remainder > 0) {
  times += 1;
}
async.timesLimit(times, 1, function(n, callback) {
  uploadChunk(callback);
}, function(err) {
  if (err) {
    console.log(err);
  }

  //
});
